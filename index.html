<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KADAM CLASH Â· territory runner</title>
    <!-- Leaflet (map) -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Turf.js for geospatial ops (buffer, distance) -->
    <script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
    <!-- Font Awesome 6 (icons) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Roboto, system-ui, -apple-system, sans-serif;
        }
        body, html {
            height: 100%;
            width: 100%;
            background: #0b0c10;
            overflow: hidden;
            touch-action: pan-x pan-y;
        }
        #map {
            height: 100%;
            width: 100%;
            background: #1a1e26;
            z-index: 1;
        }
        /* top user bar (collapsible feel) */
        .top-header {
            position: absolute;
            top: 16px;
            left: 16px;
            right: 16px;
            background: rgba(18, 22, 28, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid #2f3747;
            border-radius: 60px;
            padding: 10px 18px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            z-index: 1000;
            box-shadow: 0 10px 25px -5px rgba(0,0,0,0.7);
            color: #fff;
        }
        .user-info {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            font-size: 1.1rem;
        }
        .user-info i {
            color: #f5b342;
            font-size: 1.6rem;
            filter: drop-shadow(0 0 5px #f5b34280);
        }
        .btn-icon {
            background: #2a313f;
            border: none;
            color: white;
            width: 44px;
            height: 44px;
            border-radius: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.3rem;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid #404a5c;
        }
        .btn-icon:active { background: #3d475b; }
        /* user panel dropdown */
        .user-panel {
            position: absolute;
            top: 90px;
            left: 16px;
            right: 16px;
            background: #1e2430;
            border-radius: 32px;
            padding: 20px;
            z-index: 1001;
            border: 1px solid #3e485c;
            box-shadow: 0 20px 35px -8px black;
            display: none;
            backdrop-filter: blur(10px);
        }
        .user-panel input {
            width: 100%;
            padding: 16px 20px;
            background: #0f131c;
            border: 1px solid #354153;
            border-radius: 50px;
            color: white;
            font-size: 1rem;
            margin-bottom: 12px;
        }
        .user-panel button {
            width: 100%;
            padding: 16px;
            background: #f5b342;
            border: none;
            border-radius: 50px;
            font-weight: 700;
            font-size: 1.1rem;
            color: #0b0c10;
            margin-bottom: 16px;
            box-shadow: 0 5px 0 #a06d1f;
            transition: 0.1s;
        }
        .user-panel button:active { transform: translateY(3px); box-shadow: 0 2px 0 #a06d1f; }
        .existing-users {
            max-height: 160px;
            overflow-y: auto;
            border-radius: 20px;
            background: #151b25;
            padding: 5px;
        }
        .existing-users div {
            padding: 12px 16px;
            border-bottom: 1px solid #2c3443;
            color: #ddd;
            font-weight: 500;
            cursor: pointer;
            border-radius: 40px;
        }
        .existing-users div:active { background: #2f3a4d; }

        /* bottom sheet (main stats & leaderboard) */
        .bottom-sheet {
            position: absolute;
            bottom: 20px;
            left: 16px;
            right: 16px;
            background: rgba(18, 22, 28, 0.9);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid #3e4759;
            border-radius: 40px;
            padding: 20px 16px;
            z-index: 900;
            box-shadow: 0 -10px 30px rgba(0,0,0,0.8);
            color: white;
            max-height: 42vh;
            overflow-y: auto;
        }
        .stats-row {
            display: flex;
            justify-content: space-around;
            margin-bottom: 18px;
        }
        .stat {
            text-align: center;
            flex: 1;
        }
        .stat-value {
            font-size: 2.2rem;
            font-weight: 800;
            color: #f5b342;
            text-shadow: 0 0 10px #f5b34260;
            line-height: 1.2;
        }
        .stat-label {
            font-size: 0.8rem;
            color: #9aa6b9;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }
        .lap-splits {
            border-top: 1px solid #334152;
            padding-top: 15px;
            margin-top: 5px;
            max-height: 120px;
            overflow-y: auto;
        }
        .split-item {
            display: flex;
            justify-content: space-between;
            padding: 6px 10px;
            background: #1d2532;
            border-radius: 40px;
            margin-bottom: 5px;
            font-size: 0.95rem;
        }
        .leaderboard-title {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            margin: 15px 0 8px;
            color: #ccddf8;
        }
        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            background: #1a212e;
            padding: 8px 15px;
            border-radius: 30px;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        /* floating action button (start/stop) */
        .fab {
            position: absolute;
            bottom: 160px;
            right: 20px;
            width: 80px;
            height: 80px;
            border-radius: 60px;
            background: linear-gradient(145deg, #f5b342, #ff8800);
            border: none;
            box-shadow: 0 10px 25px #f5b34280, 0 0 0 4px #1e2430;
            color: #0a0c12;
            font-weight: 800;
            font-size: 1.3rem;
            letter-spacing: 1px;
            z-index: 1100;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #fddc9b;
        }
        .fab.stop {
            background: linear-gradient(145deg, #ff4f4f, #c03333);
            box-shadow: 0 10px 25px #ff4f4fb0, 0 0 0 4px #1e2430;
            color: white;
            border: 2px solid #ffbaba;
        }
        .fab.hidden-fab {
            display: none;
        }
        /* toast notification */
        .toast {
            position: absolute;
            bottom: 240px;
            left: 30px;
            right: 30px;
            background: #1e293b;
            color: white;
            text-align: center;
            padding: 16px 20px;
            border-radius: 60px;
            z-index: 2000;
            font-weight: 600;
            box-shadow: 0 8px 25px black;
            border-left: 6px solid #f5b342;
            animation: fadeToast 3s ease forwards;
        }
        @keyframes fadeToast {
            0% { opacity: 0; transform: translateY(20px); }
            15% { opacity: 1; transform: translateY(0); }
            85% { opacity: 1; transform: translateY(0); }
            100% { opacity: 0; transform: translateY(20px); }
        }
        .hidden { display: none; }

        /* summary overlay (post run) */
        .overlay {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(8px);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        .summary-card {
            background: #1b232f;
            width: 100%;
            max-width: 360px;
            border-radius: 60px;
            padding: 32px 24px;
            border: 2px solid #f5b342;
            text-align: center;
            color: white;
            box-shadow: 0 30px 40px black;
        }
        .summary-card h2 {
            color: #f5b342;
            font-size: 2.2rem;
            margin-bottom: 20px;
            font-weight: 800;
        }
        .summary-stat {
            font-size: 1.3rem;
            margin: 12px 0;
            background: #121a26;
            padding: 12px;
            border-radius: 50px;
        }
        .share-btn {
            background: #f5b342;
            border: none;
            padding: 18px 30px;
            border-radius: 60px;
            font-weight: 700;
            font-size: 1.2rem;
            width: 100%;
            margin: 15px 0 10px;
            color: #0f1219;
        }
        #closeSummaryBtn {
            background: none;
            border: 1px solid #5f6a80;
            color: white;
            padding: 12px;
            border-radius: 40px;
            width: 100%;
        }

        /* territory preview (orange dashed) */
        .territory-preview {
            fill-opacity: 0.15;
            stroke: #ffa500;
            stroke-width: 4;
            stroke-dasharray: 8,10;
        }
        /* leaflet popup custom */
        .leaflet-popup-content { color: #111; font-weight: 500; }
    </style>
</head>
<body>
    <div id="map"></div>

    <!-- top header -->
    <div class="top-header">
        <div class="user-info">
            <i class="fas fa-map-signal"></i>
            <span id="usernameDisplay">explorer</span>
        </div>
        <button class="btn-icon" id="userMenuBtn"><i class="fas fa-user-astronaut"></i></button>
    </div>

    <!-- user panel (expandable) -->
    <div class="user-panel" id="userPanel">
        <input type="text" id="usernameInput" placeholder="your username" autocomplete="off">
        <button id="createUserBtn"><i class="fas fa-rocket"></i>  JOIN / SWITCH</button>
        <div class="existing-users" id="existingUsersList">
            <!-- dynamic list of existing users -->
        </div>
    </div>

    <!-- bottom sheet (stats, splits, leaderboard) -->
    <div class="bottom-sheet" id="bottomSheet">
        <div class="stats-row">
            <div class="stat"><span class="stat-value" id="statDistance">0.00</span><div class="stat-label">KM</div></div>
            <div class="stat"><span class="stat-value" id="statDuration">00:00</span><div class="stat-label">TIME</div></div>
            <div class="stat"><span class="stat-value" id="statPace">0:00</span><div class="stat-label">MIN/KM</div></div>
        </div>
        <div class="stats-row">
            <div class="stat"><span class="stat-value" id="statLaps">0</span><div class="stat-label">LAPS</div></div>
            <div class="stat"><span class="stat-value" id="statCalories">0</span><div class="stat-label">KCAL</div></div>
        </div>

        <!-- lap splits -->
        <div class="lap-splits" id="lapSplitsContainer">
            <div class="split-item"><span>Lap 1</span><span>0:00</span></div>
        </div>

        <!-- mini leaderboard (top territories by laps) -->
        <div class="leaderboard-title"><i class="fas fa-crown" style="color: gold;"></i> TERRITORY LEADERS</div>
        <div id="leaderboardList"></div>
    </div>

    <!-- FAB start/stop -->
    <button class="fab" id="startStopBtn">GO</button>

    <!-- toast container -->
    <div id="toast" class="toast hidden"></div>

    <!-- post-run summary overlay -->
    <div id="summaryOverlay" class="overlay hidden">
        <div class="summary-card">
            <h2>âš¡ FINISH âš¡</h2>
            <div class="summary-stat"><i class="fas fa-route"></i> <span id="summaryDist">0.00</span> km</div>
            <div class="summary-stat"><i class="fas fa-hourglass-half"></i> <span id="summaryTime">0:00</span> min</div>
            <div class="summary-stat"><i class="fas fa-gauge-high"></i> <span id="summaryPace">0:00</span> /km</div>
            <div class="summary-stat"><i class="fas fa-repeat"></i> <span id="summaryLaps">0</span> laps</div>
            <div class="summary-stat"><i class="fas fa-fire"></i> <span id="summaryCal">0</span> kcal</div>
            <button class="share-btn" id="shareBtn"><i class="fab fa-instagram"></i>  share run</button>
            <button id="closeSummaryBtn">close</button>
        </div>
    </div>

    <script>
        (function() {
            // ---------- CONFIG ----------
            const BASE_URL = 'https://kadamclashbackend.onrender.com';
            const LAP_DISTANCE = 100;        // meters per lap (gamified)
            const BUFFER_SIZE = 10;           // meters for territory polygon
            const MOVEMENT_THRESHOLD = 5;      // ignore gps drift <5m
            const SPEED_THRESHOLD_MS = 0.277;  // 1 km/h in m/s

            // ---------- GLOBAL STATE ----------
            let map;
            let currentUser = { id: null, username: null };
            let watchId = null;
            let runActive = false;
            let startTime = null;
            let pathPoints = [];               // [lng, lat] for current run
            let lastPosition = null;
            let totalDistance = 0;              // meters
            let lapCounter = 0;
            let lastLapDistance = 0;
            let lapSplits = [];                 // lap times in seconds
            let lapStartTime = null;
            let consecutiveLowSpeed = 0;

            // Layers
            let userMarker = null;
            let pathLine = null;
            let previewLayer = null;
            let territoriesLayer = null;

            // UI elements
            const usernameSpan = document.getElementById('usernameDisplay');
            const userPanel = document.getElementById('userPanel');
            const userMenuBtn = document.getElementById('userMenuBtn');
            const usernameInput = document.getElementById('usernameInput');
            const createUserBtn = document.getElementById('createUserBtn');
            const startStopBtn = document.getElementById('startStopBtn');
            const statDistance = document.getElementById('statDistance');
            const statDuration = document.getElementById('statDuration');
            const statPace = document.getElementById('statPace');
            const statLaps = document.getElementById('statLaps');
            const statCalories = document.getElementById('statCalories');
            const lapSplitsDiv = document.getElementById('lapSplitsContainer');
            const leaderboardList = document.getElementById('leaderboardList');
            const toast = document.getElementById('toast');
            const summaryOverlay = document.getElementById('summaryOverlay');
            const summaryDist = document.getElementById('summaryDist');
            const summaryTime = document.getElementById('summaryTime');
            const summaryPace = document.getElementById('summaryPace');
            const summaryLaps = document.getElementById('summaryLaps');
            const summaryCal = document.getElementById('summaryCal');
            const closeSummaryBtn = document.getElementById('closeSummaryBtn');
            const shareBtn = document.getElementById('shareBtn');

            // ---------- UTILS ----------
            const showToast = (msg, duration = 2800) => {
                toast.innerText = msg;
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.add('hidden'), duration);
            };

            const formatTime = (sec) => {
                if (!sec && sec !== 0) return '0:00';
                const m = Math.floor(sec / 60);
                const s = Math.floor(sec % 60);
                return `${m}:${s.toString().padStart(2,'0')}`;
            };

            const formatPace = (secPerKm) => {
                if (!secPerKm || !isFinite(secPerKm)) return '0:00';
                const m = Math.floor(secPerKm / 60);
                const s = Math.floor(secPerKm % 60);
                return `${m}:${s.toString().padStart(2,'0')}`;
            };

            // ---------- USER MANAGEMENT ----------
            const loadUser = () => {
                const stored = localStorage.getItem('kadam_user');
                if (stored) {
                    try {
                        currentUser = JSON.parse(stored);
                        usernameSpan.innerText = currentUser.username || 'explorer';
                    } catch (e) {}
                }
            };
            const saveUser = () => localStorage.setItem('kadam_user', JSON.stringify(currentUser));

            // fetch all users for quick switch
            const fetchUsers = async () => {
                try {
                    const res = await fetch(`${BASE_URL}/api/users`);
                    const users = await res.json();
                    const container = document.getElementById('existingUsersList');
                    container.innerHTML = '';
                    users.forEach(u => {
                        const div = document.createElement('div');
                        div.innerText = u.username;
                        div.onclick = () => {
                            currentUser = { id: u._id, username: u.username };
                            saveUser();
                            usernameSpan.innerText = u.username;
                            userPanel.style.display = 'none';
                            showToast(`ðŸ‘¤ ${u.username} loaded`);
                            loadTerritories();      // refresh colors
                        };
                        container.appendChild(div);
                    });
                } catch (e) {
                    console.warn('cannot fetch users', e);
                }
            };

            const createNewUser = async (username) => {
                if (!username.trim()) return;
                try {
                    const res = await fetch(`${BASE_URL}/api/users`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ username })
                    });
                    const user = await res.json();
                    currentUser = { id: user.id, username: user.username };
                    saveUser();
                    usernameSpan.innerText = user.username;
                    userPanel.style.display = 'none';
                    showToast(`ðŸŒŸ welcome, ${user.username}`);
                    loadTerritories();
                } catch (e) {
                    showToast('âš ï¸ offline â€” user not created');
                }
            };

            // ---------- TERRITORIES (fetch & draw) ----------
            const loadTerritories = async () => {
                try {
                    const res = await fetch(`${BASE_URL}/api/territories`);
                    const territories = await res.json();
                    territoriesLayer.clearLayers();

                    // leaderboard (top 5 by maxLaps)
                    const sorted = [...territories].sort((a,b) => (b.maxLaps||0) - (a.maxLaps||0)).slice(0,5);
                    leaderboardList.innerHTML = '';
                    sorted.forEach(t => {
                        const owner = t.ownerId?.username || 'unknown';
                        const laps = t.maxLaps || 0;
                        const item = document.createElement('div');
                        item.className = 'leaderboard-item';
                        item.innerHTML = `<span>ðŸ‘‘ ${owner}</span> <span><i class="fas fa-flag"></i> ${laps}</span>`;
                        leaderboardList.appendChild(item);
                    });

                    territories.forEach(t => {
                        if (!t.geometry) return;
                        const isOwner = currentUser.id && t.ownerId?._id === currentUser.id;
                        const color = isOwner ? '#22dd88' : '#ff5555';
                        const poly = L.geoJSON(t.geometry, {
                            style: { color, weight: 3, fillOpacity: 0.25, fillColor: color }
                        }).bindPopup(`
                            <b>${t.ownerId?.username || 'noone'}</b><br>
                            area: ${((t.area||0)/1e6).toFixed(2)} kmÂ²<br>
                            best lap: ${formatTime(t.bestTime)}<br>
                            max laps: ${t.maxLaps}
                        `);
                        territoriesLayer.addLayer(poly);
                    });
                } catch (e) {
                    showToast('territories offline');
                }
            };

            // ---------- MAP INIT ----------
            const initMap = () => {
                map = L.map('map').setView([20, 0], 2);
                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap, CartoDB'
                }).addTo(map);
                territoriesLayer = L.layerGroup().addTo(map);

                // tap on map toggles FAB (requirement)
                map.on('click', () => {
                    startStopBtn.classList.toggle('hidden-fab');
                });
                // prevent FAB click from toggling itself
                startStopBtn.addEventListener('click', (e) => e.stopPropagation());
            };

            // ---------- GPS & RUN LOGIC ----------
            const updatePreviewPolygon = () => {
                if (pathPoints.length < 2) return;
                const line = turf.lineString(pathPoints);
                const buffered = turf.buffer(line, BUFFER_SIZE, { units: 'meters' });
                if (!buffered) return;
                if (previewLayer) map.removeLayer(previewLayer);
                previewLayer = L.geoJSON(buffered.geometry, {
                    style: { color: '#ffaa33', weight: 4, opacity: 0.8, fillOpacity: 0.15, dashArray: '6,8' }
                }).addTo(map);
            };

            const updateStatsUI = () => {
                if (!runActive) return;
                const now = Date.now();
                const elapsed = (now - startTime) / 1000;
                statDuration.innerText = formatTime(elapsed);
                const distKm = totalDistance / 1000;
                statDistance.innerText = distKm.toFixed(2);
                const pace = elapsed / (distKm || 1);
                statPace.innerText = formatPace(pace);
                statLaps.innerText = lapCounter;
                const kcal = Math.round(70 * distKm);
                statCalories.innerText = kcal;
            };

            const updateLapSplitsUI = () => {
                lapSplitsDiv.innerHTML = '';
                lapSplits.forEach((t, i) => {
                    const row = document.createElement('div');
                    row.className = 'split-item';
                    row.innerHTML = `<span><i class="fas fa-rotate-right"></i> Lap ${i+1}</span><span>${formatTime(t)}</span>`;
                    lapSplitsDiv.appendChild(row);
                });
            };

            const onGpsSuccess = (pos) => {
                if (!runActive) return;
                const { latitude, longitude, speed } = pos.coords;
                const lnglat = [longitude, latitude];

                // first point
                if (!lastPosition) {
                    lastPosition = lnglat;
                    pathPoints.push(lnglat);
                    lapStartTime = Date.now();
                    if (!userMarker) userMarker = L.marker([latitude, longitude]).addTo(map);
                    else userMarker.setLatLng([latitude, longitude]);
                    map.panTo([latitude, longitude]);
                    return;
                }

                // calculate distance from last valid point
                const dist = turf.distance(turf.point(lastPosition), turf.point(lnglat), { units: 'meters' });

                // filtering: ignore if too close (<5m) or speed too low (if available)
                if (dist < MOVEMENT_THRESHOLD) {
                    consecutiveLowSpeed++;
                    if (consecutiveLowSpeed > 5) return; // stationary
                    return; // skip this point but don't accumulate
                } else {
                    consecutiveLowSpeed = 0;
                }

                if (speed !== null && speed < SPEED_THRESHOLD_MS) {
                    return; // too slow
                }

                // valid moving point
                pathPoints.push(lnglat);
                totalDistance += dist;

                // lap detection (every 100m)
                if (totalDistance - lastLapDistance >= LAP_DISTANCE) {
                    lapCounter++;
                    const lapTime = (Date.now() - lapStartTime) / 1000;
                    lapSplits.push(lapTime);
                    lapStartTime = Date.now();
                    lastLapDistance = totalDistance;
                    showToast(`ðŸ LAP ${lapCounter}  +100m`);
                    updateLapSplitsUI();
                }

                // update path line
                if (pathLine) map.removeLayer(pathLine);
                pathLine = L.polyline(pathPoints.map(p => [p[1], p[0]]), { color: '#3aa8ff', weight: 5 }).addTo(map);

                // update preview polygon
                updatePreviewPolygon();

                // move marker & center
                if (userMarker) userMarker.setLatLng([latitude, longitude]);
                else userMarker = L.marker([latitude, longitude]).addTo(map);
                map.panTo([latitude, longitude]);

                lastPosition = lnglat;
                updateStatsUI();
            };

            const onGpsError = (err) => {
                showToast('ðŸ“¡ GPS error: ' + err.message);
            };

            const startRun = () => {
                if (!currentUser.id) {
                    showToast('ðŸ‘¤ login first via top menu');
                    return;
                }
                runActive = true;
                startTime = Date.now();
                pathPoints = [];
                lastPosition = null;
                totalDistance = 0;
                lapCounter = 0;
                lapSplits = [];
                lastLapDistance = 0;
                lapStartTime = null;
                consecutiveLowSpeed = 0;

                startStopBtn.innerText = 'STOP';
                startStopBtn.classList.add('stop');

                if (pathLine) map.removeLayer(pathLine);
                if (previewLayer) map.removeLayer(previewLayer);
                if (userMarker) map.removeLayer(userMarker);
                userMarker = null;

                watchId = navigator.geolocation.watchPosition(onGpsSuccess, onGpsError, {
                    enableHighAccuracy: true,
                    maximumAge: 0,
                    timeout: 7000
                });
            };

            const stopRun = async () => {
                if (watchId) navigator.geolocation.clearWatch(watchId);
                runActive = false;
                startStopBtn.innerText = 'GO';
                startStopBtn.classList.remove('stop');

                const duration = (Date.now() - startTime) / 1000;
                const distanceKm = totalDistance / 1000;
                const avgSpeed = distanceKm / (duration / 3600) || 0;

                if (pathPoints.length < 2) {
                    showToast('move a bit to create territory');
                    return;
                }

                // create polygon via buffer
                const line = turf.lineString(pathPoints);
                const buffered = turf.buffer(line, BUFFER_SIZE, { units: 'meters' });
                if (!buffered || buffered.geometry.type !== 'Polygon') {
                    showToast('polygon error, try again');
                    return;
                }
                const polygonGeo = buffered.geometry; // plain GeoJSON Polygon

                // submit to backend
                try {
                    const res = await fetch(`${BASE_URL}/api/run`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: currentUser.id,
                            polygon: polygonGeo,
                            duration: Math.round(duration),
                            laps: lapCounter,
                            avgSpeed: avgSpeed
                        })
                    });
                    const data = await res.json();
                    if (data.created) showToast('âœ¨ new territory created!');
                    else if (data.captured) showToast('âš”ï¸ territory CAPTURED!');
                    else showToast('ðŸ“¦ run saved');

                    // show summary overlay
                    summaryDist.innerText = distanceKm.toFixed(2);
                    summaryTime.innerText = formatTime(duration);
                    const pace = duration / (distanceKm || 1);
                    summaryPace.innerText = formatPace(pace);
                    summaryLaps.innerText = lapCounter;
                    summaryCal.innerText = Math.round(70 * distanceKm);
                    summaryOverlay.classList.remove('hidden');

                    loadTerritories(); // refresh
                } catch (e) {
                    showToast('offline â€” run not submitted');
                }

                // cleanup map layers
                if (pathLine) map.removeLayer(pathLine);
                if (previewLayer) map.removeLayer(previewLayer);
                if (userMarker) map.removeLayer(userMarker);
                userMarker = null;
            };

            // ---------- EVENT LISTENERS ----------
            userMenuBtn.onclick = () => {
                if (userPanel.style.display === 'none' || !userPanel.style.display) {
                    userPanel.style.display = 'block';
                    fetchUsers();
                } else {
                    userPanel.style.display = 'none';
                }
            };

            createUserBtn.onclick = () => {
                createNewUser(usernameInput.value);
            };

            startStopBtn.onclick = (e) => {
                e.stopPropagation();
                if (runActive) stopRun();
                else startRun();
            };

            closeSummaryBtn.onclick = () => {
                summaryOverlay.classList.add('hidden');
            };

            shareBtn.onclick = () => {
                showToast('ðŸ“¸ screenshot & share with #kadamclash');
            };

            // ---------- BOOTSTRAP ----------
            initMap();
            loadUser();
            fetchUsers(); // preload user list for panel
            loadTerritories();
            setInterval(loadTerritories, 45000); // refresh territories

            // hide user panel if click outside (simple)
            document.addEventListener('click', (e) => {
                if (!userPanel.contains(e.target) && !userMenuBtn.contains(e.target)) {
                    userPanel.style.display = 'none';
                }
            });
        })();
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Kadam Clash</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;}
body{background:#0b0f1a;color:white;overflow:hidden;height:100vh;}
#map{position:fixed;top:0;left:0;height:100vh;width:100vw;z-index:1;}
.leaflet-control-zoom{margin-top:90px !important;} /* FIX burger overlap */

.top-left-ui{
position:fixed;
top:20px;
left:20px;
z-index:1000;
display:flex;
flex-direction:column;
gap:12px;
}

.menu-btn{
width:44px;height:44px;border-radius:50%;
background:#111827;display:flex;align-items:center;
justify-content:center;cursor:pointer;
}
.menu-btn div{width:18px;height:2px;background:white;position:relative;}
.menu-btn div::before,.menu-btn div::after{
content:"";position:absolute;width:18px;height:2px;background:white;left:0;
}
.menu-btn div::before{top:-6px;}
.menu-btn div::after{top:6px;}

.profile-chip{
background:rgba(17,24,39,0.9);
padding:10px 16px;
border-radius:50px;
font-size:14px;
}

.run-panel{
position:fixed;
bottom:0;
left:0;
right:0;
background:linear-gradient(to top,#0f172a,#111827);
border-top-left-radius:28px;
border-top-right-radius:28px;
padding:20px;
z-index:1000;
box-shadow:0 -10px 40px rgba(0,0,0,0.8);
}

.stats{
display:flex;
justify-content:space-between;
margin-bottom:16px;
}

.stat{text-align:center;}
.stat span{display:block;font-size:12px;opacity:0.6;}
.stat b{font-size:22px;}

.run-btn{
width:100%;
padding:16px;
border:none;
border-radius:50px;
font-size:18px;
font-weight:700;
cursor:pointer;
background:#22c55e;
color:#0b1120;
}

.run-btn.running{background:#ef4444;color:white;}

.toast{
position:fixed;
top:80px;
left:50%;
transform:translateX(-50%);
background:#111827;
padding:12px 20px;
border-radius:50px;
display:none;
z-index:2000;
}
</style>
</head>

<body>

<div id="map"></div>

<div class="top-left-ui">
<div class="menu-btn" onclick="selectRunner()"><div></div></div>
<div class="profile-chip" id="profileName">Not selected</div>
</div>

<div class="run-panel">
<div class="stats">
<div class="stat"><span>Distance</span><b id="distance">0.00</b> km</div>
<div class="stat"><span>Time</span><b id="duration">00:00</b></div>
<div class="stat"><span>Laps</span><b id="laps">0</b></div>
</div>
<button class="run-btn" id="runBtn" onclick="toggleRun()" disabled>Start Run</button>
</div>

<div class="toast" id="toast"></div>

<script>
const API_BASE='https://kadamclashbackend.onrender.com';

let map,currentPosition=null,isRunning=false;
let selectedUserId=null,selectedUsername=null;
let runPath=[],runStartTime=null,runTimer=null;
let pathLayer,territoryLayer,livePolygonLayer;

const runBtn=document.getElementById('runBtn');
const profileName=document.getElementById('profileName');
const distanceEl=document.getElementById('distance');
const durationEl=document.getElementById('duration');
const lapsEl=document.getElementById('laps');
const toast=document.getElementById('toast');

function showToast(msg){
toast.innerText=msg;
toast.style.display='block';
setTimeout(()=>toast.style.display='none',3000);
}

/* MAP */
function initMap(){
map=L.map('map',{zoomControl:true}).setView([20,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);
pathLayer=L.layerGroup().addTo(map);
territoryLayer=L.layerGroup().addTo(map);
livePolygonLayer=L.layerGroup().addTo(map);

if(!navigator.geolocation)return showToast("GPS not supported");

navigator.geolocation.watchPosition(pos=>{
currentPosition=[pos.coords.latitude,pos.coords.longitude];
if(!isRunning)return;
addPoint(currentPosition);
},()=>showToast("Enable GPS"),{enableHighAccuracy:true});
}

/* USER */
async function selectRunner(){
const name=prompt("Enter username:");
if(!name)return;

try{
const res=await fetch(`${API_BASE}/api/users`,{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({username:name.trim()})
});
const user=await res.json();
selectedUserId=user.id||user._id;
selectedUsername=user.username;
profileName.innerText="üèÉ "+selectedUsername;
runBtn.disabled=false;
loadTerritories();
}catch{showToast("Server offline");}
}

/* RUN */
function toggleRun(){
if(!selectedUserId)return showToast("Select user first");
if(!currentPosition)return showToast("Waiting GPS");

isRunning=!isRunning;

if(isRunning){
runPath=[];
runStartTime=Date.now();
runBtn.innerText="Stop Run";
runBtn.classList.add('running');
runTimer=setInterval(updateStats,1000);
}else{
stopRun();
}
}

function addPoint(pos){
runPath.push(pos);
drawPath();
updateLivePolygon();
updateStats();
}

function drawPath(){
pathLayer.clearLayers();
if(runPath.length<2)return;
L.polyline(runPath,{color:'#22c55e',weight:5}).addTo(pathLayer);
}

function updateLivePolygon(){
if(runPath.length<3)return;
livePolygonLayer.clearLayers();
const coords=runPath.map(p=>[p[1],p[0]]);
const line=turf.lineString(coords);
const buffered=turf.buffer(line,8,{units:'meters'});
L.geoJSON(buffered,{style:{color:'#22c55e',fillOpacity:0.3}}).addTo(livePolygonLayer);
}

async function stopRun(){
isRunning=false;
clearInterval(runTimer);
runBtn.innerText="Start Run";
runBtn.classList.remove('running');

if(runPath.length<5)return showToast("Run too short");

const coords=runPath.map(p=>[p[1],p[0]]);
const line=turf.lineString(coords);
const buffered=turf.buffer(line,8,{units:'meters'});

try{
await fetch(`${API_BASE}/api/run`,{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({
userId:selectedUserId,
polygon:buffered.geometry
})
});
showToast("Territory Created!");
loadTerritories();
}catch{showToast("Server error");}

runPath=[];
livePolygonLayer.clearLayers();
pathLayer.clearLayers();
}

/* LOAD TERRITORIES */
async function loadTerritories(){
territoryLayer.clearLayers();
try{
const res=await fetch(`${API_BASE}/api/territories`);
const data=await res.json();
data.forEach(t=>{
if(!t.geometry)return;
L.geoJSON(t.geometry,{
style:{
color:'#ef4444',
fillOpacity:0.2
}
}).addTo(territoryLayer);
});
}catch{}
}

/* STATS */
function updateStats(){
if(!runStartTime)return;
const secs=Math.floor((Date.now()-runStartTime)/1000);
const mins=Math.floor(secs/60);
const s=secs%60;
durationEl.innerText=`${mins.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

initMap();
</script>

</body>
</html>

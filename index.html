<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Kadam Clash ‚Äì Territory Runner</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;}
body{background:#0b0f1a;color:white;overflow:hidden;height:100vh;}
#map{position:fixed;top:0;left:0;height:100vh;width:100vw;z-index:1;}
.leaflet-tile{filter:brightness(0.7) contrast(1.2) saturate(0.8);}

/* TOP BAR */
.top-bar{position:fixed;top:14px;left:14px;right:14px;z-index:50;display:flex;justify-content:space-between;align-items:center;pointer-events:none;}
.glass-chip{background:rgba(15,23,42,0.85);backdrop-filter:blur(16px);border:1px solid rgba(255,255,255,0.08);border-radius:50px;padding:10px 16px;font-size:13px;display:flex;align-items:center;gap:8px;pointer-events:auto;}
.status-chip.online{background:#052e1a;border-color:#22c55e;}

/* MENU */
.menu-btn{width:42px;height:42px;border-radius:50%;background:#0f172a;display:flex;align-items:center;justify-content:center;cursor:pointer;pointer-events:auto;}
.menu-btn div{width:18px;height:2px;background:white;position:relative;}
.menu-btn div::before,.menu-btn div::after{content:"";position:absolute;width:18px;height:2px;background:white;left:0;}
.menu-btn div::before{top:-6px;}
.menu-btn div::after{top:6px;}

.side-menu{position:fixed;top:0;left:-280px;height:100vh;width:260px;background:#0f172a;z-index:100;padding:28px 20px;transition:0.3s;display:flex;flex-direction:column;}
.side-menu.open{left:0;}
.menu-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.6);z-index:90;display:none;}
.menu-overlay.show{display:block;}

.menu-item{padding:14px 10px;border-radius:12px;font-size:15px;margin-bottom:10px;cursor:pointer;}
.menu-item:hover{background:#1e293b;}

/* RUN CARD */
.run-card-container{position:fixed;bottom:0;left:0;right:0;z-index:60;padding:18px;}
.run-card{background:#111827;border-radius:28px;padding:22px 20px 26px;}
.runner-name{text-align:center;font-size:18px;font-weight:600;margin-bottom:18px;color:#22c55e;}
.stats-grid{display:grid;grid-template-columns:1fr 1fr;gap:18px 12px;margin-bottom:20px;}
.stat-cell{text-align:center;}
.stat-label{font-size:11px;opacity:0.6;}
.stat-number{font-size:28px;font-weight:800;margin-top:4px;}
.stat-unit{font-size:11px;opacity:0.6;margin-left:2px;}
.run-action-btn{width:100%;padding:16px;border:none;border-radius:50px;font-size:18px;font-weight:700;cursor:pointer;background:#22c55e;color:#0b1120;}
.run-action-btn.running{background:#ef4444;color:white;}
.hint-text{text-align:center;margin-top:10px;font-size:12px;opacity:0.6;}

.toast{position:fixed;top:80px;left:50%;transform:translateX(-50%);background:#111827;padding:14px 22px;border-radius:50px;font-weight:600;display:none;z-index:200;}
.toast.success{background:#065f46;}
.toast.error{background:#7f1d1d;}
</style>
</head>

<body>

<div id="map"></div>

<div class="menu-overlay" id="menuOverlay"></div>

<div class="side-menu" id="sideMenu">
<h2 style="color:#22c55e;">Kadam Clash</h2>
<div class="menu-item" onclick="selectRunner()">üë§ My Profile</div>
</div>

<div class="top-bar">
<div class="menu-btn" onclick="toggleMenu()"><div></div></div>
<div class="glass-chip" id="locationInfo">üì° Acquiring GPS...</div>
<div class="glass-chip" id="apiStatus">Connecting...</div>
</div>

<div class="run-card-container">
<div class="run-card">
<div class="runner-name" id="runnerDisplay">üèÉ Start Running</div>

<div class="stats-grid">
<div class="stat-cell">
<div class="stat-label">Distance</div>
<div class="stat-number" id="distance">0.00</div><span class="stat-unit">km</span>
</div>
<div class="stat-cell">
<div class="stat-label">Duration</div>
<div class="stat-number" id="duration">00:00</div>
</div>
<div class="stat-cell">
<div class="stat-label">Laps</div>
<div class="stat-number" id="laps">0</div>
</div>
<div class="stat-cell">
<div class="stat-label">Speed</div>
<div class="stat-number" id="avgSpeed">0.0</div><span class="stat-unit">km/h</span>
</div>
</div>

<button class="run-action-btn" id="runBtn" disabled onclick="toggleRun()">‚ñ∂ Start Run</button>
<div class="hint-text" id="runHint">Select profile to begin</div>
</div>
</div>

<div id="toast" class="toast"></div>

<script>
const API_BASE='https://kadamclashbackend.onrender.com';
let map,currentPosition=null,watchId=null,isRunning=false,selectedUserId=null,selectedUsername=null;
let runPath=[],runStartTime=null,runTimer=null,lapCount=0;

const locationEl=document.getElementById('locationInfo');
const apiStatusEl=document.getElementById('apiStatus');
const runBtn=document.getElementById('runBtn');
const runnerDisplay=document.getElementById('runnerDisplay');
const runHint=document.getElementById('runHint');
const distanceEl=document.getElementById('distance');
const durationEl=document.getElementById('duration');
const lapsEl=document.getElementById('laps');
const avgSpeedEl=document.getElementById('avgSpeed');
const toast=document.getElementById('toast');

function showToast(msg,type='info'){
toast.className=`toast ${type}`;
toast.innerText=msg;
toast.style.display='block';
setTimeout(()=>toast.style.display='none',3000);
}

function toggleMenu(){
document.getElementById('sideMenu').classList.toggle('open');
document.getElementById('menuOverlay').classList.toggle('show');
}
document.getElementById('menuOverlay').onclick=toggleMenu;

async function checkAPI(){
try{
const res=await fetch(`${API_BASE}/health`);
const data=await res.json();
if(data.database==='connected'){
apiStatusEl.innerText='‚úÖ Server ready';
apiStatusEl.classList.add('online');
}else apiStatusEl.innerText='‚ö†Ô∏è DB issue';
}catch{apiStatusEl.innerText='‚ùå Offline';}
}
checkAPI();

window.selectRunner=async function(){
const name=prompt('Enter runner name:');
if(!name)return;
try{
const res=await fetch(`${API_BASE}/api/users`,{
method:'POST',
headers:{'Content-Type':'application/json'},
body:JSON.stringify({username:name.trim()})
});
if(!res.ok)throw new Error();
const user=await res.json();
selectedUserId=user.id||user._id;
selectedUsername=user.username;
runnerDisplay.innerText=`üèÉ ${selectedUsername}`;
runBtn.disabled=false;
runHint.innerText='Ready to run';
showToast(`Welcome ${selectedUsername}`,'success');
}catch{
showToast('User creation failed','error');
}
};

function initMap(){
map=L.map('map').setView([20,0],2);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map);

if(!navigator.geolocation){
locationEl.innerText='‚ùå GPS not supported';
return;
}

navigator.geolocation.getCurrentPosition(pos=>{
currentPosition=[pos.coords.latitude,pos.coords.longitude];
map.setView(currentPosition,17);
L.marker(currentPosition).addTo(map);
locationEl.innerText='üìç GPS Ready';
},geoError,{enableHighAccuracy:true,timeout:10000});

watchId=navigator.geolocation.watchPosition(pos=>{
currentPosition=[pos.coords.latitude,pos.coords.longitude];
locationEl.innerText=`üìç ${pos.coords.latitude.toFixed(5)}, ${pos.coords.longitude.toFixed(5)}`;
},geoError,{enableHighAccuracy:true,maximumAge:0,timeout:8000});
}

function geoError(err){
if(err.code===1)locationEl.innerText='‚ùå GPS permission denied';
else if(err.code===2)locationEl.innerText='‚ö†Ô∏è Location unavailable';
else if(err.code===3)locationEl.innerText='‚è≥ GPS timeout';
showToast('Enable GPS','error');
}

window.toggleRun=function(){
if(!selectedUserId)return showToast('Select runner first','error');
if(!currentPosition)return showToast('Waiting for GPS','error');
if(!isRunning)startRun();else stopRun();
};

function startRun(){
isRunning=true;
runStartTime=Date.now();
runPath=[];
lapCount=0;
runBtn.innerText='‚èπ Stop Run';
runBtn.classList.add('running');
runHint.innerText='Running...';
runTimer=setInterval(updateStats,1000);
showToast('Run started','success');
}

function stopRun(){
isRunning=false;
clearInterval(runTimer);
runBtn.innerText='‚ñ∂ Start Run';
runBtn.classList.remove('running');
runHint.innerText='Run complete';
showToast('Run stopped','success');
}

function updateStats(){
const secs=Math.floor((Date.now()-runStartTime)/1000);
const mins=Math.floor(secs/60);
const s=secs%60;
durationEl.innerText=`${mins.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

initMap();
</script>

</body>
</html>
